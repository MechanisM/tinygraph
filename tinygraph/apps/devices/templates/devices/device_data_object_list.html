{% extends "devices/devices_base.html" %}

{% block content_area %}

    <div id="path">
        <a href="{{ device.get_absolute_url }}">{{ device.user_given_name }}</a> <span>/ Data Objects</span>
    </div>
    
    {% if new_device %}
        <p>
            So, you have just created <code>{{ device.user_given_name }}</code>, the next step is to start adding some <strong>Data Objects</strong> which you would like to track!
        </p>
    {% else %}
        <p>
            These are the <strong>Data Objects</strong> which <code>{{ device.user_given_name }}</code> is tracking.
        </p>
    {% endif %}
    
    <h3>Packages</h3>
    
    <p>
        A package is a predefined group of data objects which makes enabling and disabling them a synch.
    </p>
    
    <div class="packages">
        {% for package, package_instance in packages_map %}
            <div packageInstancePK="{{ package_instance.pk }}" packagePK="{{ package.pk }}" class="package {% if package_instance.enabled %}enabled{% endif %}">
                <input class="toggle" type="checkbox" name="{{ package.slug }}"{% if package_instance.enabled %} checked="true"{% endif %}>
                <h5>{{ package.title }}</h5>
                <p>{{ package.description }}</p>
                <p>
                    <a href="{% url definitions:package_detail package_slug=package.slug %}">Read More</a>
                </p>
            </div>
        {% endfor %}
    </div>
    
    <h3>Individual Data Objects</h3>
    
    <p>
        You can also add data objects to record individually.
    </p>
    
    {% with device.data_objects.all as device_objects %}
        {% include "definitions/includes/data_object_table.html" %}
    {% endwith %}
{% endblock %}

{% block scripts %}
    <script type="text/javascript" charset="utf-8">
        $(function() {
            var PACKAGE_INSTANCE_URL = '{% url api:rules:package_instances %}';
            var CSRF_TOKEN = '{{ csrf_token }}';
            var DEVICE_PK = '{{ device.pk }}';
            
            $('.package .toggle:checkbox').change(function() {
                var $p = $(this).closest('.package');
                $p.toggleClass('enabled');
                
                var packageInstancePK = $p.attr('packageInstancePK');
                var packagePK = $p.attr('packagePK');
                var isEnabled = $p.is('.enabled') ? 'True' : '';
                
                if (packageInstancePK === '') {
                    $.ajax({
                        url: PACKAGE_INSTANCE_URL,
                        type: 'post',
                        context: $p,
                        data: {
                            device: DEVICE_PK,
                            package: packagePK,
                            enabled: true,
                            csrfmiddlewaretoken: CSRF_TOKEN
                        },
                        success: function(data) {
                            this.attr('packageInstancePK', data['id']);
                        }
                    })
                } else {
                    $.ajax({
                        url: PACKAGE_INSTANCE_URL + packageInstancePK + '/',
                        type: 'put',
                        context: $p,
                        data: {
                            enabled: isEnabled,
                            csrfmiddlewaretoken: CSRF_TOKEN
                        },
                        dataType: 'json'
                    });
                }
            });
        })
    </script>
{% endblock %}